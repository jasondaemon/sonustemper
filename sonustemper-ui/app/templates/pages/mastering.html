{% extends "base.html" %}
{% block page_title %}Mastering | SonusTemper{% endblock %}
{% block title %}Mastering{% endblock %}
{% block subtitle %}Run mastering jobs with voicings/presets, loudness, stereo/tone, and output options.{% endblock %}
{% block sidebar %}
  <div class="card">
    <div class="card-head">
      <div>
        <div class="card-title">Processing Status</div>
        <div class="muted">Live status via event stream.</div>
      </div>
    </div>
    <div class="status-list" id="statusList">(waiting)</div>
  </div>
  <div class="card">
    <div class="card-head">
      <div>
        <div class="card-title">Previous Runs</div>
        <div class="muted">Recent runs will appear here.</div>
      </div>
    </div>
    <!-- Runs list is populated by JS (so we can auto-select + avoid double-fetch with HTMX). -->
    <div id="prevRunsWrap"></div>
  </div>
{% endblock %}

{% block content %}
  <div class="master-grid">
    <div class="card job-card full-width">
      <div class="card-head">
        <div>
          <div class="card-title">Master</div>
          <div class="muted">Pick a source, choose voicing or preset, tune loudness/stereo, and outputs.</div>
        </div>
        <div class="muted hx-indicator" id="jobIndicator">Working…</div>
      </div>
      <form id="masterForm">
        <div class="master-stages">
          <div class="stage-card input-stage">
            <div class="stage-head">
              <div class="stage-title">Input</div>
              <div class="stage-actions">
                <input type="file" id="inputUpload" accept=".wav,.mp3,.flac,.aiff,.aif,.m4a,.ogg,.aac" multiple hidden>
                <button type="button" class="btn ghost small" id="uploadBtn">Upload</button>
              </div>
            </div>
            <div class="input-list" id="inputList">
              <div class="input-empty muted">Loading…</div>
            </div>
          </div>

          <div class="stage-row">
            <div class="stage-card">
              <div class="stage-title">Voicing</div>
              <div class="control-row">
                <div class="control-label">Mode</div>
                <div class="pill-row">
                  <label><input type="radio" name="voicing_mode" value="voicing" id="mode_voicing" checked> Voicing</label>
                  <label><input type="radio" name="voicing_mode" value="presets" id="mode_presets"> Preset</label>
                </div>
              </div>
              <div class="control-row" id="voicingRow">
                <div class="control-label">Voicing</div>
                <select id="voicingSelect">
                  <option value="universal">Universal</option>
                  <option value="airlift">Airlift</option>
                  <option value="ember">Ember</option>
                  <option value="detail">Detail</option>
                  <option value="glue">Glue</option>
                  <option value="wide">Wide</option>
                  <option value="cinematic">Cinematic</option>
                  <option value="punch">Punch</option>
                </select>
              </div>
              <div class="control-row hidden" id="presetRow">
                <div class="control-label">Preset</div>
                <select id="presetSelect">
                  <option value="">Loading presets…</option>
                </select>
              </div>
              <div class="control-row">
                <div class="control-label">Strength</div>
                <input type="range" id="strength" min="0" max="100" value="80" oninput="document.getElementById('strengthVal').textContent=this.value;">
                <div class="value-pill">S=<span id="strengthVal">80</span></div>
              </div>
              <div class="control-row">
                <label class="control-label inline"><input type="checkbox" id="ov_width"> Override Stereo Width</label>
                <input type="range" id="width" min="0.5" max="1.5" step="0.01" value="1.0" oninput="document.getElementById('widthVal').textContent=this.value;">
                <div class="value-pill">Width=<span id="widthVal">1.0</span></div>
              </div>
              <div class="control-row">
                <label class="control-label inline"><input type="checkbox" id="ov_mono_bass"> Mono Bass Below (Hz)</label>
                <input type="range" id="mono_bass" min="60" max="200" step="1" value="120" oninput="document.getElementById('monoBassVal').textContent=this.value;">
                <div class="value-pill">Hz=<span id="monoBassVal">120</span></div>
              </div>
              <div class="control-row">
                <label class="control-label inline"><input type="checkbox" id="guardrails" checked> Enable guardrails</label>
              </div>
            </div>

            <div class="stage-card">
              <div class="stage-title">Profile</div>
              <div class="control-row">
                <div class="control-label">Profile</div>
                <select id="loudnessMode">
                  <option value="apple" selected>Apple Music (-16, -1)</option>
                  <option value="spotify">Spotify (-14, -1)</option>
                  <option value="loud">Loud (-11, -1)</option>
                  <option value="manual">Manual</option>
                </select>
              </div>
              <div class="control-subtitle">Overrides</div>
              <div class="control-row">
                <label class="control-label inline"><input type="checkbox" id="ov_target_I" checked disabled> Loudness</label>
                <input type="number" step="0.1" id="target_I" value="-16.0">
                <div class="value-pill">LUFS</div>
              </div>
              <div class="control-row">
                <label class="control-label inline"><input type="checkbox" id="ov_target_TP" checked disabled> True Peak</label>
                <input type="number" step="0.1" id="target_TP" value="-1.0">
                <div class="value-pill">dBTP</div>
              </div>
              <div class="control-row">
                <label class="control-label inline"><input type="checkbox" id="stage_analyze" checked> Enable analysis (metrics)</label>
              </div>
            </div>
          </div>

          <div class="stage-card">
            <div class="stage-title">Output</div>
            <div class="format-row">
              <label class="format-label"><input type="checkbox" id="out_wav" checked> WAV</label>
              <div class="format-options">
                <select id="wav_bit_depth">
                  <option value="24">24-bit</option>
                  <option value="16">16-bit</option>
                </select>
                <select id="wav_sample_rate">
                  <option value="48000">48 kHz</option>
                  <option value="44100">44.1 kHz</option>
                </select>
              </div>
            </div>
            <div class="format-row">
              <label class="format-label"><input type="checkbox" id="out_mp3" checked> MP3</label>
              <div class="format-options">
                <select id="mp3_bitrate">
                  <option value="320">320 kbps</option>
                  <option value="256">256 kbps</option>
                  <option value="192">192 kbps</option>
                  <option value="128">128 kbps</option>
                </select>
                <select id="mp3_vbr">
                  <option value="none">None (CBR)</option>
                  <option value="V0">V0</option>
                  <option value="V2">V2</option>
                </select>
              </div>
            </div>
            <div class="format-row">
              <label class="format-label"><input type="checkbox" id="out_aac"> AAC/M4A</label>
              <div class="format-options">
                <select id="aac_codec">
                  <option value="aac">AAC (native)</option>
                  <option value="aac">AAC (faac)</option>
                </select>
                <select id="aac_container">
                  <option value="m4a">M4A</option>
                  <option value="aac">AAC</option>
                </select>
                <select id="aac_bitrate">
                  <option value="256">256 kbps</option>
                  <option value="192">192 kbps</option>
                  <option value="128">128 kbps</option>
                </select>
              </div>
            </div>
            <div class="format-row">
              <label class="format-label"><input type="checkbox" id="out_ogg"> OGG</label>
              <div class="format-options">
                <select id="ogg_quality">
                  <option value="5">Q5 (~160 kbps)</option>
                  <option value="4">Q4</option>
                  <option value="6">Q6</option>
                </select>
              </div>
            </div>
            <div class="format-row">
              <label class="format-label"><input type="checkbox" id="out_flac"> FLAC</label>
              <div class="format-options">
                <select id="flac_level">
                  <option value="5">Level 5</option>
                  <option value="8">Level 8</option>
                  <option value="1">Level 1</option>
                </select>
                <select id="flac_bit_depth">
                  <option value="">Auto bit depth</option>
                  <option value="24">24-bit</option>
                  <option value="16">16-bit</option>
                </select>
                <select id="flac_sample_rate">
                  <option value="">Auto rate</option>
                  <option value="48000">48 kHz</option>
                  <option value="44100">44.1 kHz</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="btn" id="runBtn" disabled>Run Job</button>
          <a class="btn ghost" href="/legacy">Legacy UI</a>
        </div>
      </form>
    </div>

    <div class="card full-width" id="outputPaneWrap">
      <div class="card" id="outputPane" style="background:transparent;border:none;padding:0;">
        <div class="card-head">
          <div>
            <div class="card-title">Job Output</div>
            <div class="muted">Select a run to view outputs.</div>
          </div>
        </div>
        <div class="muted">Output list placeholder.</div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const indicator = document.getElementById('jobIndicator');
  const statusList = document.getElementById('statusList');
  const outputPaneWrap = document.getElementById('outputPaneWrap');

  let currentRun = null;
  let statusSource = null;
  let statusLines = [];
  let statusRenderPending = false;

  function esc(str){
    if(!str) return '';
    if(window.CSS && CSS.escape) return CSS.escape(str);
    return String(str).replace(/[^a-zA-Z0-9_-]/g, '\$&');
  }

  function setBusy(on){
    if(!indicator) return;
    indicator.style.display = on ? 'inline-block' : 'none';
  }
  setBusy(false);

  function scheduleStatusRender(){
    if(statusRenderPending) return;
    statusRenderPending = true;
    requestAnimationFrame(()=>{
      statusRenderPending = false;
      if(!statusList) return;
      statusList.textContent = statusLines.length ? statusLines.join('\n') : '(waiting)';
    });
  }

  function setCurrentRun(song){
    const next = song || null;
    // Avoid restarting the stream (and clearing the log) if the same run is selected again.
    if(next === currentRun && statusSource){
      return;
    }
    currentRun = next;
    startStatusStream();
  }

  function closeStatusStream(){
    if(statusSource){
      statusSource.close();
      statusSource = null;
    }
  }

  function startStatusStream(){
    closeStatusStream();
    statusLines = [];
    scheduleStatusRender();
    if(!currentRun){
      return;
    }
    const url = `/api/status-stream?song=${encodeURIComponent(currentRun)}`;
    let es;
    try{
      es = new EventSource(url);
      statusSource = es;
      statusLines.push('(connecting…)');
      scheduleStatusRender();
    }catch(err){
      statusLines.push('Event stream unavailable');
      scheduleStatusRender();
      return;
    }
    es.onmessage = (ev)=>{
      let data;
      try{ data = JSON.parse(ev.data); }catch(_){ data = { detail: ev.data }; }
      const ts = data.ts ? new Date(data.ts*1000).toLocaleTimeString() : '';
      const stage = data.stage || '';
      const detail = data.detail || data.message || '';
      const line = [ts, stage, detail].filter(Boolean).join(' ');
      if(line) statusLines.push(line);
      scheduleStatusRender();
      if(data.stage === 'complete' || data.stage === 'error'){
        closeStatusStream();
        // Refresh sidebar list ONLY (do not auto-click a run, or you'll restart SSE forever)
        refreshPrevRuns(false);
      }
    };
    es.onerror = ()=>{
      closeStatusStream();
      statusLines.push('(status unavailable)');
      scheduleStatusRender();
    };
  }

  async function loadFiles(){
    try{
      const res = await fetch('/api/files',{cache:'no-store'});
      const data = await res.json();
      const list = document.getElementById('inputList');
      const presetSel = document.getElementById('presetSelect');
      const prevSelected = new Set(
        [...(list ? list.querySelectorAll('input[name="infiles"]:checked') : [])].map(cb => cb.value)
      );
      if (list) {
        list.innerHTML = '';
        const files = data.files || [];
        if (!files.length) {
          const empty = document.createElement('div');
          empty.className = 'input-empty muted';
          empty.textContent = 'No source files found';
          list.appendChild(empty);
        } else {
          files.forEach((f, idx) => {
            const item = document.createElement('label');
            item.className = 'input-item';
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.name = 'infiles';
            cb.value = f;
            cb.checked = prevSelected.has(f) || (!prevSelected.size && idx === 0);
            const text = document.createElement('span');
            text.textContent = f;
            item.appendChild(cb);
            item.appendChild(text);
            list.appendChild(item);
          });
        }
      }
      presetSel.innerHTML = '';
      (data.presets || []).forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        presetSel.appendChild(opt);
      });
      if(presetSel.options.length===0){
        const opt = document.createElement('option');
        opt.value='';
        opt.textContent='No presets found';
        presetSel.appendChild(opt);
      }
      validateForm();
    }catch(e){
      showToast('Failed to load files');
    }
  }
  loadFiles();

  const uploadBtn = document.getElementById('uploadBtn');
  const uploadInput = document.getElementById('inputUpload');

  function triggerUpload(){
    if (uploadInput) uploadInput.click();
  }

  async function uploadFilesSequential(files){
    for (let i = 0; i < files.length; i++){
      const f = files[i];
      const fd = new FormData();
      fd.append('files', f, f.name);
      const res = await fetch('/api/upload', { method: 'POST', body: fd });
      if (!res.ok){
        const msg = await res.text();
        throw new Error(msg || `Upload failed: ${f.name}`);
      }
    }
  }

  if (uploadBtn && uploadInput){
    uploadBtn.addEventListener('click', triggerUpload);
    uploadBtn.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        triggerUpload();
      }
    });
  }

  if (uploadInput){
    uploadInput.addEventListener('change', async ()=>{
      const files = [...(uploadInput.files || [])];
      if (!files.length) return;
      try{
        showToast('Uploading…');
        await uploadFilesSequential(files);
        await loadFiles();
        showToast('Upload complete');
      }catch(err){
        showToast('Upload failed');
      }finally{
        uploadInput.value = '';
      }
    });
  }

  async function loadOutput(song){
    if(!song || !outputPaneWrap) return;
    try{
      const res = await fetch(`/ui/partials/master_output?song=${encodeURIComponent(song)}`, {cache:'no-store'});
      if(!res.ok){
        outputPaneWrap.innerHTML = `
          <div class="card" id="outputPane" style="background:transparent;border:none;padding:0;">
            <div class="card-head">
              <div>
                <div class="card-title">Job Output</div>
                <div class="muted">No output found for <strong>${song}</strong>.</div>
              </div>
            </div>
          </div>`;
        return;
      }
      outputPaneWrap.innerHTML = await res.text();
    }catch(err){
      showToast('Failed to load output');
    }
  }

  async function refreshPrevRuns(selectLatest, preferSong){
    try{
      const res = await fetch('/ui/partials/master_prev',{cache:'no-store'});
      const html = await res.text();
      const wrap = document.getElementById('prevRunsWrap');
      if(wrap){
        wrap.innerHTML = html;
        const desired = preferSong && wrap.querySelector(`.run-item[data-song="${esc(preferSong)}"]`);
        if(desired){
          desired.click();
        }else if(selectLatest){
          const firstBtn = wrap.querySelector('.run-item');
          if(firstBtn){ firstBtn.click(); }
        }
      }
    }catch(err){
      showToast('Failed to refresh runs');
    }
  }

  // initial prev list and no auto-select
  refreshPrevRuns(false);

  const form = document.getElementById('masterForm');
  const runBtn = document.getElementById('runBtn');

  const loudProfiles = {
    apple: { lufs: -16.0, tp: -1.0 },
    spotify: { lufs: -14.0, tp: -1.0 },
    loud: { lufs: -11.0, tp: -1.0 },
  };

  function applyLoudnessMode(){
    const mode = document.getElementById('loudnessMode').value;
    const ovI = document.getElementById('ov_target_I');
    const ovTP = document.getElementById('ov_target_TP');
    const tI = document.getElementById('target_I');
    const tTP = document.getElementById('target_TP');
    if(mode === 'manual'){
      ovI.disabled = false; ovTP.disabled = false;
      ovI.checked = false; ovTP.checked = false;
      return;
    }
    const prof = loudProfiles[mode] || loudProfiles.apple;
    tI.value = prof.lufs;
    tTP.value = prof.tp;
    ovI.checked = true; ovTP.checked = true;
    ovI.disabled = true; ovTP.disabled = true;
  }
  document.getElementById('loudnessMode').addEventListener('change', applyLoudnessMode);
  applyLoudnessMode();

  function setModeUI(){
    const mode = document.querySelector('input[name="voicing_mode"]:checked')?.value || 'voicing';
    const voRow = document.getElementById('voicingRow');
    const prRow = document.getElementById('presetRow');
    if(mode === 'voicing'){
      voRow.classList.remove('hidden');
      prRow.classList.add('hidden');
    }else{
      voRow.classList.add('hidden');
      prRow.classList.remove('hidden');
    }
    validateForm();
  }
  document.getElementById('mode_voicing').addEventListener('change', setModeUI);
  document.getElementById('mode_presets').addEventListener('change', setModeUI);
  setModeUI();

  function selectedInfiles(){
    return [...document.querySelectorAll('#inputList input[name="infiles"]:checked')].map(cb => cb.value);
  }

  function validateForm(){
    const files = selectedInfiles();
    const mode = document.querySelector('input[name="voicing_mode"]:checked')?.value || 'voicing';
    const vo = document.getElementById('voicingSelect')?.value || '';
    const pr = document.getElementById('presetSelect')?.value || '';
    const ok = files.length && ((mode==='voicing' && vo) || (mode==='presets' && pr));
    if(runBtn) runBtn.disabled = !ok;
  }
  const inputList = document.getElementById('inputList');
  if (inputList) inputList.addEventListener('change', validateForm);
  document.getElementById('voicingSelect').addEventListener('change', validateForm);
  document.getElementById('presetSelect').addEventListener('change', validateForm);

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    setBusy(true);

    const fd = new FormData();
    const files = selectedInfiles();
    fd.append('infiles', files.join(','));
    fd.append('strength', document.getElementById('strength').value || '80');
    // stages
    fd.append('stage_analyze', document.getElementById('stage_analyze').checked ? '1' : '0');
    fd.append('stage_master', '1');
    fd.append('stage_loudness', '1');
    fd.append('stage_stereo', '1');
    fd.append('stage_output', '1');
    // voicing / preset
    const mode = document.querySelector('input[name="voicing_mode"]:checked')?.value || 'voicing';
    fd.append('voicing_mode', mode);
    if(mode === 'voicing'){
      fd.append('voicing_name', document.getElementById('voicingSelect').value || '');
    }else{
      fd.append('presets', document.getElementById('presetSelect').value || '');
    }
    // loudness
    if(document.getElementById('ov_target_I').checked){
      fd.append('lufs', document.getElementById('target_I').value || '');
    }
    if(document.getElementById('ov_target_TP').checked){
      fd.append('tp', document.getElementById('target_TP').value || '');
    }
    // stereo/tone
    if(document.getElementById('ov_width').checked){
      fd.append('width', document.getElementById('width').value || '');
    }
    if(document.getElementById('ov_mono_bass').checked){
      fd.append('mono_bass', document.getElementById('mono_bass').value || '');
    }
    if(document.getElementById('guardrails').checked){
      fd.append('guardrails','1');
    }
    // outputs
    const on = id => document.getElementById(id)?.checked;
    const val = id => document.getElementById(id)?.value || '';
    fd.append('out_wav', on('out_wav') ? '1' : '0');
    fd.append('wav_bit_depth', val('wav_bit_depth'));
    fd.append('wav_sample_rate', val('wav_sample_rate'));
    fd.append('out_mp3', on('out_mp3') ? '1' : '0');
    fd.append('mp3_bitrate', val('mp3_bitrate'));
    fd.append('mp3_vbr', val('mp3_vbr') || 'none');
    fd.append('out_aac', on('out_aac') ? '1' : '0');
    fd.append('aac_codec', val('aac_codec'));
    fd.append('aac_container', val('aac_container'));
    fd.append('aac_bitrate', val('aac_bitrate'));
    fd.append('out_ogg', on('out_ogg') ? '1' : '0');
    fd.append('ogg_quality', val('ogg_quality'));
    fd.append('out_flac', on('out_flac') ? '1' : '0');
    fd.append('flac_level', val('flac_level'));
    fd.append('flac_bit_depth', val('flac_bit_depth'));
    fd.append('flac_sample_rate', val('flac_sample_rate'));

    try{
      const res = await fetch('/api/run',{method:'POST', body: fd});
      if(!res.ok){
        const err = await res.json().catch(()=>({detail:'error'}));
        showToast('Run failed: '+ (err.detail || res.status));
      }else{
        showToast('Job started');

        // IMPORTANT: backend run_id is folder name (usually infile without extension).
        // Prefer explicit run_ids from the API, then fall back to stripping extension.
        let runId = null;
        try{
          const j = await res.json();
          if(j && j.primary_run_id){
            runId = j.primary_run_id;
          }else if(j && Array.isArray(j.run_ids) && j.run_ids.length){
            runId = j.run_ids[0];
          }
        }catch(_){ /* ignore */ }
        if(!runId){
          const first = files[0] || '';
          runId = first.replace(/\.[^.]+$/, '') || first;
        }

        setCurrentRun(runId);
        loadOutput(runId);
        refreshPrevRuns(true, runId);
      }
    }catch(err){
      showToast('Network error');
    }finally{
      setBusy(false);
    }
  });

  // track run selection clicks to update status polling target + output pane
  document.addEventListener('click', function(evt){
    const btn = evt.target.closest && evt.target.closest('.run-item');
    if(btn && btn.dataset && btn.dataset.song){
      const song = btn.dataset.song;
      setCurrentRun(song);
      loadOutput(song);
    }
  });

  window.addEventListener('beforeunload', closeStatusStream);
})();
</script>
{% endblock %}
