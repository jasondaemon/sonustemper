{% extends "base.html" %}
{% block page_title %}Mastering | SonusTemper{% endblock %}
{% block title %}Mastering{% endblock %}
{% block subtitle %}Run mastering jobs in the new UI.{% endblock %}
{% block sidebar %}
  <div class="card">
    <div class="card-head">
      <div>
        <div class="card-title">Processing Status</div>
        <div class="muted">Live status via event stream.</div>
      </div>
    </div>
    <div class="status-list" id="statusList">(waiting)</div>
  </div>
  <div class="card">
    <div class="card-head">
      <div>
        <div class="card-title">Previous Runs</div>
        <div class="muted">Recent runs will appear here.</div>
      </div>
    </div>
    <div id="prevRunsWrap" hx-get="/ui/partials/master_prev" hx-trigger="load"></div>
  </div>
{% endblock %}

{% block content %}
  <div class="master-grid">
    <div class="card job-card full-width">
      <div class="card-head">
        <div>
          <div class="card-title">Master</div>
          <div class="muted">Pick a source, choose voicing, loudness, and outputs.</div>
        </div>
        <div class="muted hx-indicator" id="jobIndicator">Working…</div>
      </div>
      <form id="masterForm">
        <div class="form-grid">
          <div class="form-row">
            <label>Input file</label>
            <select name="infile" id="infileSelect" required>
              <option value="">Loading…</option>
            </select>
          </div>
          <div class="form-row">
            <label>Voicing</label>
            <select name="voicing_name" id="voicingSelect">
              <option value="universal">Universal</option>
              <option value="airlift">Airlift</option>
              <option value="ember">Ember</option>
              <option value="detail">Detail</option>
              <option value="glue">Glue</option>
              <option value="wide">Wide</option>
              <option value="cinematic">Cinematic</option>
              <option value="punch">Punch</option>
            </select>
            <input type="hidden" name="voicing_mode" value="voicing">
          </div>
          <div class="form-row">
            <label>Strength</label>
            <input type="range" name="strength" id="strength" min="0" max="100" value="80" oninput="document.getElementById('strengthVal').textContent=this.value;">
            <div class="muted">S=<span id="strengthVal">80</span></div>
          </div>
          <div class="form-row">
            <label>Loudness</label>
            <div class="pill">Apple Music</div>
            <input type="hidden" name="lufs" value="-16.0">
            <input type="hidden" name="tp" value="-1.0">
          </div>
          <div class="form-row outputs">
            <label>Outputs</label>
            <div class="output-grid">
              <label><input type="checkbox" name="out_wav" value="1" checked> WAV</label>
              <label><input type="checkbox" name="out_mp3" value="1" checked> MP3</label>
              <label><input type="checkbox" name="out_aac" value="1"> AAC/M4A</label>
              <label><input type="checkbox" name="out_ogg" value="1"> OGG</label>
              <label><input type="checkbox" name="out_flac" value="1"> FLAC</label>
            </div>
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="btn">Run Job</button>
          <a class="btn ghost" href="/">Legacy UI</a>
        </div>
      </form>
    </div>

    <div class="card full-width" id="outputPaneWrap">
      <div class="card" id="outputPane" style="background:transparent;border:none;padding:0;">
        <div class="card-head">
          <div>
            <div class="card-title">Job Output</div>
            <div class="muted">Select a run to view outputs.</div>
          </div>
        </div>
        <div class="muted">Output list placeholder.</div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const indicator = document.getElementById('jobIndicator');
  const statusList = document.getElementById('statusList');
  let currentRun = null;
  let statusSource = null;
  let statusLines = [];
  let reconnectDelay = 1000;

  function esc(str){
    if(!str) return '';
    if(window.CSS && CSS.escape) return CSS.escape(str);
    return String(str).replace(/[^a-zA-Z0-9_-]/g, '\\$&');
  }

  function setBusy(on){
    if(!indicator) return;
    indicator.style.display = on ? 'inline-block' : 'none';
  }
  setBusy(false);

  function renderStatus(){
    if(!statusList) return;
    statusList.textContent = statusLines.length ? statusLines.join('\\n') : '(waiting)';
  }

  function setCurrentRun(song){
    currentRun = song || null;
    startStatusStream();
  }

  function closeStatusStream(){
    if(statusSource){
      statusSource.close();
      statusSource = null;
    }
  }

  function startStatusStream(){
    closeStatusStream();
    statusLines = [];
    renderStatus();
    if(!currentRun){
      return;
    }
    const url = `/api/status-stream?song=${encodeURIComponent(currentRun)}`;
    let es;
    try{
      es = new EventSource(url);
      statusSource = es;
      statusLines.push('(connecting…)');
      renderStatus();
    }catch(err){
      statusLines.push('Event stream unavailable');
      renderStatus();
      return;
    }
    es.onmessage = (ev)=>{
      reconnectDelay = 1000;
      let data;
      try{ data = JSON.parse(ev.data); }catch(_){ data = { detail: ev.data }; }
      const ts = data.ts ? new Date(data.ts*1000).toLocaleTimeString() : '';
      const stage = data.stage || '';
      const detail = data.detail || data.message || '';
      const line = [ts, stage, detail].filter(Boolean).join(' ');
      if(line) statusLines.push(line);
      renderStatus();
      if(data.stage === 'complete' || data.stage === 'error'){
        closeStatusStream();
        refreshPrevRuns(false, currentRun, true);
      }
    };
    es.onerror = ()=>{
      closeStatusStream();
      statusLines.push('(disconnected)');
      renderStatus();
      const delay = reconnectDelay;
      reconnectDelay = Math.min(reconnectDelay * 2, 10000);
      setTimeout(()=>{ if(currentRun && !statusSource){ startStatusStream(); } }, delay);
    };
  }

  async function loadFiles(){
    try{
      const res = await fetch('/api/files',{cache:'no-store'});
      const data = await res.json();
      const sel = document.getElementById('infileSelect');
      sel.innerHTML = '';
      (data.files || []).forEach(f=>{
        const opt = document.createElement('option');
        opt.value = f;
        opt.textContent = f;
        sel.appendChild(opt);
      });
      if(sel.options.length===0){
        const opt = document.createElement('option');
        opt.value='';
        opt.textContent='No source files found';
        sel.appendChild(opt);
      }
    }catch(e){
      showToast('Failed to load files');
    }
  }
  loadFiles();

  async function refreshPrevRuns(selectLatest, preferSong, loadOutputOnly){
    try{
      const res = await fetch('/ui/partials/master_prev',{cache:'no-store'});
      const html = await res.text();
      const wrap = document.getElementById('prevRunsWrap');
      if(wrap){
        wrap.innerHTML = html;
        const desired = preferSong && wrap.querySelector(`.run-item[data-song="${esc(preferSong)}"]`);
        if(desired){
          desired.click();
        }else if(selectLatest){
          const firstBtn = wrap.querySelector('.run-item');
          if(firstBtn){ firstBtn.click(); }
        }else if(loadOutputOnly && preferSong){
          const anyBtn = wrap.querySelector('.run-item');
          if(anyBtn){ anyBtn.click(); }
        }
      }
    }catch(err){
      showToast('Failed to refresh runs');
    }
  }
  // initial prev list and auto-select latest output
  refreshPrevRuns(true);

  const form = document.getElementById('masterForm');
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    setBusy(true);
    const fd = new FormData(form);
    // ensure default stages stay enabled; guardrails on by default for stereo
    fd.append('guardrails','1');
    try{
      const res = await fetch('/api/run',{method:'POST', body: fd});
      if(!res.ok){
        const err = await res.json().catch(()=>({detail:'error'}));
        showToast('Run failed: '+ (err.detail || res.status));
      }else{
        showToast('Job started');
        const runId = fd.get('infile');
        setCurrentRun(runId);
        refreshPrevRuns(true, runId);
      }
    }catch(err){
      showToast('Network error');
    }finally{
      setBusy(false);
    }
  });

  // track run selection clicks to update status polling target
  document.addEventListener('click', function(evt){
    const btn = evt.target.closest && evt.target.closest('.run-item');
    if(btn && btn.dataset && btn.dataset.song){
      setCurrentRun(btn.dataset.song);
    }
  });
  window.addEventListener('beforeunload', closeStatusStream);

  // auto-load most recent on page load
  refreshPrevRuns(true);
})();
</script>
{% endblock %}
